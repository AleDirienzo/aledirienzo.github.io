<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Max Ricci - Portofolio 2025</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <div class="logo">Max Ricci</div>
        <div class="hero-meta">
            <div>
                <span>Based in</span>
                Lugano, CH
            </div>
            <div>
                <span>Discipline</span>
                Design / Art
            </div>
        </div>
    </nav>

    <section class="hero">
        <h1>PERSONAL PORTFOLIO<br>INDUSTRIAL DESIGN<br>2025-2026</h1>
        
        <ul class="nav-links">
            <li><a href="#work">Work</a></li>
            <li><a href="about.html">About Max</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </section>

    <section class="projects-section" id="work">
        <div class="section-header">
            <h2 class="section-title">Selected Works</h2>
            <div class="section-number">[05]</div>
        </div>
        
        <div class="projects-list">
            <div class="project-item">
                <div class="project-number">[01]</div>
                <div class="project-title">THREE O' CLOCK</div>
                <div class="project-description">Time & Perception</div>
                <div class="project-year">2025</div>
            </div>

            <div class="project-item">
                <div class="project-number">[02]</div>
                <div class="project-title">ARCH-ITECTURE</div>
                <div class="project-description">Spatial Forms</div>
                <div class="project-year">2025</div>
            </div>

            <div class="project-item">
                <div class="project-number">[03]</div>
                <div class="project-title">MOI</div>
                <div class="project-description">Visual Diary</div>
                <div class="project-year">2025</div>
            </div>
            
            <div class="project-item">
                <div class="project-number">[04]</div>
                <div class="project-title">SINK DISH</div>
                <div class="project-description">Domestic Object</div>
                <div class="project-year">2025</div>
            </div>

            <div class="project-item">
                <div class="project-number">[05]</div>
                <div class="project-title">AI SPONGE</div>
                <div class="project-description">Generative Tool</div>
                <div class="project-year">2025</div>
            </div>
        </div>
    </section>

    <section class="other-projects-section">
        <div class="section-header">
            <h2 class="section-title">Other Projects</h2>
            <div class="section-number">[â€”]</div>
        </div>
        <div class="other-grid">
            <div class="other-project-card">
                <img src="images/other-01.jpg" alt="Other Project 1">
                <div class="card-caption">Other 01</div>
            </div>
            <div class="other-project-card">
                <img src="images/other-02.jpg" alt="Other Project 2">
                <div class="card-caption">Other 02</div>
            </div>
            <div class="other-project-card">
                <img src="images/other-03.jpg" alt="Other Project 3">
                <div class="card-caption">Other 03</div>
            </div>
            <div class="other-project-card">
                <img src="images/other-04.jpg" alt="Other Project 4">
                <div class="card-caption">Other 04</div>
            </div>
        </div>
    </section>

    <div class="project-visual" id="projectVisual"></div>

    <!-- Project modal (hidden until opened) -->
    <div class="modal-overlay" id="projectModal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <button class="modal-close" id="modalClose" aria-label="Close">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="carousel" id="modalCarousel">
                    <button class="nav prev" id="carouselPrev">â€¹</button>
                    <img id="carouselImage" src="" alt="Project image">
                    <button class="nav next" id="carouselNext">â€º</button>
                    <div class="carousel-empty" id="carouselEmpty" style="display:none;color:#888;">Images will be added later.</div>
                    <div class="thumbnails" id="carouselThumbs" aria-hidden="true"></div>
                </div>
                <aside class="modal-side">
                    <div class="desc" id="modalDesc"></div>
                </aside>
            </div>
            <div class="modal-footer" id="modalFooter">Project details</div>
        </div>
    </div>

    <script>
        (function(){
            const projects = document.querySelectorAll('.project-item');
            const visual = document.getElementById('projectVisual');

            // Basic hover preview (keeps previous behavior)
            projects.forEach((project, i) => {
                project.addEventListener('mouseenter', () => {
                    if (window.innerWidth > 1024) {
                        visual.style.opacity = '1';
                        const icons = ['ðŸ•’', 'ðŸ›ï¸', 'âœ¨', 'ðŸ¥£', 'ðŸ¤–'];
                        visual.textContent = icons[i] || '';
                        // warm remaining images for this project on hover
                        prefetchRemaining(projectData[i].imagePrefix);
                    }
                });

                project.addEventListener('mouseleave', () => {
                    visual.style.opacity = '0';
                });

                project.addEventListener('click', () => openProjectModal(i));
            });

            // Project data (titles/descriptions from DOM for reliability)
            const projectData = Array.from(projects).map((el, i) => ({
                index: i,
                title: el.querySelector('.project-title')?.textContent || ('Project ' + (i+1)),
                description: el.querySelector('.project-description')?.textContent || '',
                // image prefix to look for in /images â€” convention: project-01-1.jpg
                imagePrefix: `project-${String(i+1).padStart(2,'0')}`
            }));

            // Hybrid preload state
            const preloadedFirst = {}; // prefix -> first image url
            const preloadedAll = {};   // prefix -> array of other image urls (2..N)
            const prefetching = {};    // prefix -> boolean

            // Try loading variants (.jpg then .png) for a given prefix and index. Resolves url or null.
            function tryLoadVariant(prefix, n){
                const exts = ['jpg','png'];
                return new Promise((resolve) => {
                    let i = 0;
                    function next(){
                        if (i >= exts.length) return resolve(null);
                        const url = `images/${prefix}-${n}.${exts[i]}`;
                        const img = new Image();
                        img.onload = () => resolve(url);
                        img.onerror = () => { i++; next(); };
                        img.src = url;
                    }
                    next();
                });
            }

            // Preload the first image for every project (cheap, small number)
            function preloadFirstImages(){
                projectData.forEach(d => {
                    tryLoadVariant(d.imagePrefix, 1).then(url => {
                        if (url) preloadedFirst[d.imagePrefix] = url;
                    });
                });
            }

            // Prefetch remaining images (2..6) for a specific project prefix
            function prefetchRemaining(prefix){
                if (prefetching[prefix]) return;
                prefetching[prefix] = true;
                preloadedAll[prefix] = preloadedAll[prefix] || [];
                const promises = [];
                for (let n = 2; n <= 6; n++){
                    promises.push(tryLoadVariant(prefix, n).then(url => {
                        if (url) preloadedAll[prefix].push(url);
                    }));
                }
                Promise.all(promises).finally(()=>{ prefetching[prefix] = false; });
            }

            // Start by preloading the first images
            preloadFirstImages();

            // Modal elements
            const modalOverlay = document.getElementById('projectModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDesc = document.getElementById('modalDesc');
            const modalClose = document.getElementById('modalClose');
            const modalFooter = document.getElementById('modalFooter');
            const carouselImage = document.getElementById('carouselImage');
            const carouselEmpty = document.getElementById('carouselEmpty');
            const carouselThumbs = document.getElementById('carouselThumbs');
            const prevBtn = document.getElementById('carouselPrev');
            const nextBtn = document.getElementById('carouselNext');

            if (!modalOverlay || !modalTitle) {
                console.error('Modal elements not found â€” modal markup may be missing');
            }

            let currentImages = [];
            let currentIndex = 0;
            let loadToken = 0; // incremental token to avoid race conditions from overlapping loads

            function openProjectModal(i){
                try {
                    const data = projectData[i];
                    if (!modalTitle || !modalOverlay) throw new Error('Modal missing');
                    modalTitle.textContent = data.title;
                    modalDesc.textContent = data.description;
                    modalFooter.textContent = `${data.title} â€¢ ${data.index+1}`;
                    modalOverlay.classList.add('active');
                    // Prevent stale results from previous load: increment token and capture
                    loadToken += 1;
                    const myToken = loadToken;
                    // reset UI while loading
                    clearThumbnails();
                    if (carouselImage) { carouselImage.style.display = 'none'; carouselImage.src = ''; }
                    if (carouselEmpty) { carouselEmpty.style.display = ''; }
                    // If we already have preloaded images, use them immediately (first image + prefetches)
                    const prefix = data.imagePrefix;
                    const preFirst = preloadedFirst[prefix] || null;
                    const preOthers = preloadedAll[prefix] || [];
                    if (preFirst || preOthers.length){
                        // ensure this load is still current
                        if (myToken !== loadToken) return;
                        // assemble ordered images: first then others
                        const imgs = [];
                        if (preFirst) imgs.push(preFirst);
                        imgs.push(...preOthers);
                        currentImages = imgs;
                        currentIndex = 0;
                        if (currentImages.length){
                            if (carouselEmpty) carouselEmpty.style.display = 'none';
                            if (carouselImage) { carouselImage.style.display = ''; carouselImage.src = currentImages[0]; }
                            populateThumbnails(currentImages);
                        } else {
                            if (carouselImage) carouselImage.style.display = 'none';
                            if (carouselEmpty) carouselEmpty.style.display = '';
                            clearThumbnails();
                        }
                        // also, kick off any remaining prefetch to fill gaps
                        prefetchRemaining(prefix);
                    } else {
                        // try load images matching prefix, up to 6
                        loadImagesForProject(data.imagePrefix, 6, (imgs) => {
                            // ignore if another load started after this one
                            if (myToken !== loadToken) return;
                            currentImages = imgs;
                            currentIndex = 0;
                            if (currentImages.length){
                                if (carouselEmpty) carouselEmpty.style.display = 'none';
                                if (carouselImage) { carouselImage.style.display = ''; carouselImage.src = currentImages[0]; }
                                populateThumbnails(currentImages);
                            } else {
                                if (carouselImage) carouselImage.style.display = 'none';
                                if (carouselEmpty) carouselEmpty.style.display = '';
                                clearThumbnails();
                            }
                        });
                    }
                    if (modalClose) modalClose.focus();
                } catch (err) {
                    console.error('Failed to open project modal', err);
                }
            }

            function closeModal(){
                if (!modalOverlay) return;
                modalOverlay.classList.remove('active');
                if (carouselImage) carouselImage.src = '';
                currentImages = [];
            }

            if (modalClose) modalClose.addEventListener('click', closeModal);
            if (modalOverlay) modalOverlay.addEventListener('click', (e)=>{
                if (e.target === modalOverlay) closeModal();
            });

            // keyboard support
            document.addEventListener('keydown', (e)=>{
                if (!modalOverlay || !modalOverlay.classList.contains('active')) return;
                if (e.key === 'Escape') closeModal();
                if (e.key === 'ArrowLeft') showPrev();
                if (e.key === 'ArrowRight') showNext();
            });

            if (prevBtn) prevBtn.addEventListener('click', showPrev);
            if (nextBtn) nextBtn.addEventListener('click', showNext);

            // Smooth slide to Selected Works when clicking "Work"
            (function(){
                const workAnchors = document.querySelectorAll('.nav-links a[href="#work"]');
                const nav = document.querySelector('nav');
                workAnchors.forEach(a => a.addEventListener('click', (e)=>{
                    e.preventDefault();
                    const target = document.querySelector('#work');
                    if (!target) return;
                    const navHeight = nav ? nav.offsetHeight : 0;
                    const top = target.getBoundingClientRect().top + window.scrollY - navHeight - 8;
                    window.scrollTo({ top, behavior: 'smooth' });
                }));
            })();

            function showPrev(){
                if (!currentImages.length || !carouselImage) return;
                currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
                carouselImage.src = currentImages[currentIndex];
            }

            function showNext(){
                if (!currentImages.length || !carouselImage) return;
                currentIndex = (currentIndex + 1) % currentImages.length;
                carouselImage.src = currentImages[currentIndex];
                highlightActiveThumb();
            }

            // Attempt to load images with a naming convention: images/{prefix}-{n}.jpg
            function loadImagesForProject(prefix, maxCount, cb){
                const loaded = [];
                const ext = ['jpg','png'];
                function tryNext(n){
                    if (n > maxCount){
                        cb(loaded);
                        return;
                    }
                    let extIndex = 0;
                    function tryExt(){
                        if (extIndex >= ext.length){
                            tryNext(n+1);
                            return;
                        }
                        const url = `images/${prefix}-${n}.${ext[extIndex]}`;
                        const img = new Image();
                        img.onload = ()=>{ loaded.push(url); tryNext(n+1); };
                        img.onerror = ()=>{ extIndex++; tryExt(); };
                        img.src = url;
                    }
                    tryExt();
                }
                tryNext(1);
            }

            function populateThumbnails(urls){
                clearThumbnails();
                if (!carouselThumbs) return;
                urls.forEach((u, idx) => {
                    const t = document.createElement('img');
                    t.src = u;
                    t.alt = `Thumbnail ${idx+1}`;
                    t.className = 'thumb';
                    t.addEventListener('click', (e)=>{
                        currentIndex = idx;
                        if (carouselImage) carouselImage.src = currentImages[currentIndex];
                        highlightActiveThumb();
                    });
                    carouselThumbs.appendChild(t);
                });
                highlightActiveThumb();
            }

            function clearThumbnails(){
                if (!carouselThumbs) return;
                carouselThumbs.innerHTML = '';
            }

            function highlightActiveThumb(){
                if (!carouselThumbs) return;
                const thumbs = carouselThumbs.querySelectorAll('.thumb');
                thumbs.forEach((t,i)=> t.classList.toggle('active-thumb', i===currentIndex));
            }
        })();
    </script>
    <footer class="footer">
        <div>Â© 2025 Max Ricci</div>
        <div>Lugano, Switzerland</div>
    </footer>

</body>
</html>
